define job load_f_ticket_from_ventes_private
description 'Load stg.ventes_private to core.f_ticket table'
(
    define schema ventes_schema
    (
        TKNUM       numeric,
        LOCID       numeric,
        PAYMCD      integer,
        CLIID       integer,
        TKDT        intdate,
        TKHR        inttime,
        TKNETAMT    decimal,
    );

    define operator export_ventes
    type export
    schema ventes_schema
    attributes
    (
        varchar UserName = 'dbc',
        varchar UserPassword = 'dbc',
        varchar SelectSmt = 'select unique
                                cast(TKNUM as integer),
                                cast(LOCID as integer),
                                cast(PAYMCD as char(2)),
                                CLIID as integer,
                                cast(TKDT as date format ''DD/MM/YY'') +
                                    interval '100' year,
                                cast(TKHR as time format ''HH:MI:SS''),
                                cast(TKNETAMT as number)
                             from DB_PRDW_STG.ventes_private
                             where
                                regexp_similar(TKDT,
                                    '[0-9]{2}/[0-9]{2}/[0-9]{2}', 'c') = 1 and
                                regexp_similar(TKHR
                                    '[0-9]{2}:[0-9]{2}:[0-9]{2}', 'c') = 1 and
                                CLISTATCD <> '0';'
    );

    define operator load_ventes
    type load
    schema ventes_schema
    attributes
    (
        varchar UserName = 'dbc',
        varchar UserPassword = 'dbc',
        varchar TargetTable = 'DB_PRDW_CORE.f_ticket',
        varchar LogTable = 'DB_PRDW_CORE.log_f_ticket'
    );

    apply ('insert into DB_PRDW_CORE.f_ticket(
            num_ticket, id_magasin, moyen_paiement, id_client, dt_ticket,
            heure, prix_total)
        values (:tknum, :locid, :paymcd, :cliid, :tkdt, :tkhr, :tknetamt);')
    to operator (load_ventes[1])

    select TKNUM, LOCID, PAYMCD, CLIID, TKDT, TKHR, TKNETAMT
    from operator (export_ventes[1]);
);
